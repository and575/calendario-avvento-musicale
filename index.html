<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Calendario Avvento Musicale</title>
<style>
  body{font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;background:#f5f7fa;color:#333;padding:20px;}
  h1{text-align:center;color:#2c3e50;margin-bottom:30px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;}
  .cell{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:12px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);}
  .artist{color:#e74c3c;}
  .listen-link{display:inline-block;margin-top:6px;color:#0066cc;text-decoration:none;font-weight:600;}
  .listen-link:hover{ text-decoration:underline; }
  .qr-img{margin-top:8px;border:1px solid #ddd;border-radius:4px;}
/* --- Form proposta brano --- */
.form-section{
  max-width: 520px;
  margin: 40px auto;
}

.form-card{
  background:#ffffff;
  border-radius:16px;
  padding:24px 24px 20px;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 25px rgba(15,23,42,0.06);
}

.form-card h2{
  margin-top:0;
  margin-bottom:4px;
  font-size:1.35rem;
  color:#111827;
}

.form-subtitle{
  margin:0 0 20px;
  font-size:0.9rem;
  color:#6b7280;
}

.form-grid{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.form-field label{
  display:block;
  font-size:0.85rem;
  font-weight:600;
  color:#4b5563;
  margin-bottom:4px;
}

.form-field input{
  width:100%;
  border-radius:10px;
  border:1px solid #d1d5db;
  padding:9px 11px;
  font-size:0.95rem;
  background:#f9fafb;
  transition:border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
}

.form-field input:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 1px rgba(37,99,235,0.35);
  background:#ffffff;
}

.form-hint{
  font-size:0.78rem;
  color:#9ca3af;
  margin-top:2px;
}

.form-actions{
  margin-top:18px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:12px;
}

.form-button{
  border:none;
  border-radius:999px;
  padding:9px 18px;
  font-size:0.9rem;
  font-weight:600;
  cursor:pointer;
  background:#2563eb;
  color:#ffffff;
  box-shadow:0 8px 20px rgba(37,99,235,0.25);
  transition:background-color 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
}

.form-button:hover{
  background:#1d4ed8;
  transform:translateY(-1px);
  box-shadow:0 12px 30px rgba(37,99,235,0.35);
}

.form-button:active{
  transform:translateY(0);
  box-shadow:0 6px 15px rgba(37,99,235,0.2);
}

#formMessage{
  margin-top:10px;
  font-size:0.85rem;
}

  
</style>
</head>
<body>

<h1>Calendario Avvento Musicale</h1>
<div id="calendar" class="grid"></div>

<div class="form-section">
  <div class="form-card">
    <h2>Aggiungi un nuovo brano</h2>
    <p class="form-subtitle">
      Compila i campi qui sotto per proporre un brano per il calendario.
    </p>

    <form id="proposalForm" class="form-grid">
      <div class="form-field">
        <label for="giorno">Giorno (9–30)</label>
        <input id="giorno" type="number" name="Giorno" min="9" max="30" required>
        <p class="form-hint">Scegli un giorno ancora libero del calendario.</p>
      </div>

      <div class="form-field">
        <label for="titolo">Titolo</label>
        <input id="titolo" type="text" name="Titolo" required>
      </div>

      <div class="form-field">
        <label for="artista">Artista</label>
        <input id="artista" type="text" name="Artista" required>
      </div>

      <div class="form-field">
        <label for="propostoDa">Proposto da</label>
        <input id="propostoDa" type="text" name="Proposto da" required>
      </div>

      <div class="form-field">
        <label for="url">URL YouTube Music</label>
        <input id="url" type="url" name="URL"
               placeholder="https://music.youtube.com/…" required>
        <p class="form-hint">Incolla il link al brano (meglio se da YouTube Music).</p>
      </div>

      <div class="form-actions">
        <button type="submit" class="form-button">Invia proposta</button>
      </div>
    </form>

    <p id="formMessage"></p>
  </div>
</div>

<script>
/* ---------- CONFIGURAZIONE ---------- */
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbB8anD_KDj7SJ_2zoUdRQsVSEl5HSoOe20m4PGYB73BqnJ9Kx5HS2dfokbOMeQiIQJJPzRvo1N3xv/pub?gid=0&single=true&output=csv';
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgpAeaRRtw62_UGl6hKPHp6OxcpXUxEhscoi35DOzTNoKXbKJgBdDvZH5BohRoEZseMg/exec'; // <-- verifica

/* ---------- FUNZIONI ---------- */
function parseCSV(text){
  const rows = text.trim().split('\n');
  const headers = rows[0].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(h=>h.replace(/^"|"$/g,'').trim());
  return rows.slice(1).map(line=>{
    const cols = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (cols[i]||'').replace(/^"|"$/g,'').trim());
    return obj;
  });
}
function qrImg(url, size=150){
  if (!url) return '';
  const enc = encodeURIComponent(url);
  return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${enc}`;
}

/* ---------- RENDER ---------- */
async function render(){
  try{
    const resp = await fetch(csvUrl);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = parseCSV(await resp.text());

    data.sort((a,b)=> Number(a.Giorno)-Number(b.Giorno));

    const container = document.getElementById('calendar');
    container.innerHTML = '';

    data.forEach(row=>{
      const cell = document.createElement('div');
      cell.className = 'cell';
      const qr = qrImg(row.URL);
      cell.innerHTML = `
        <h3>${row.Giorno} Dicembre</h3><br><br>
        <em>Titolo:</em> ${row.Titolo}<br>
        <em>Artista:</em> <span class="artist">${row.Artista}</span><br>
        <em>Proposto da:</em><strong> ${row['Proposto da'] || '—'}</strong><br><br>
        ${qr ? `<a href="${row.URL}" target="_blank" rel="noopener" class="listen-link">▶️ Ascolta</a><br>` : ''}
        ${qr ? `<img src="${qr}" alt="QR per giorno ${row.Giorno}" class="qr-img">` : '<p>URL non disponibile</p>'}
      `;
      container.appendChild(cell);
    });
  }catch(err){
    console.error('Errore nel render:', err);
    document.getElementById('calendar').innerHTML =
      `<p style="color:red;">Impossibile caricare i dati. Controlla l’URL del CSV.</p>`;
  }
}

/* ---------- GESTIONE DEL FORM ---------- */
function initFormHandler(){
  const form = document.getElementById('proposalForm');
  const msgEl = document.getElementById('formMessage');

  if (!form) { console.error('Form non trovato!'); return; }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = {};
    new FormData(form).forEach((v,k)=> data[k] = v.trim());

    msgEl.textContent = 'Invio in corso…';
    msgEl.style.color = '#555';

    try{
     const resp = await fetch(APP_SCRIPT_URL, {
     method: 'POST',
    headers: {
    'Content-Type': 'text/plain;charset=utf-8'   // <-- importante
     },
     body: JSON.stringify(data)
      });
      const result = await resp.json();

      if (result.status === 'ok'){
        msgEl.textContent = '✅ Proposta registrata! Aggiornamento calendario…';
        msgEl.style.color = '#28a745';
        form.reset();
        render();   // ricarica il calendario
      }else{
        throw new Error(result.msg || 'Errore sconosciuto');
      }
    }catch(err){
      console.error('Errore nella submit:', err);
      msgEl.textContent = `❌ Errore: ${err.message}`;
      msgEl.style.color = '#c00';
    }
  });
}

/* ---------- AVVIO ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  render();          // disegna il calendario
  initFormHandler(); // attiva il form
});
</script>

</body>
</html>
